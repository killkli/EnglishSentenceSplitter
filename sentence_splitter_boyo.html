<!DOCTYPE HTML>
<html>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html">
<head>
	<meta charset="UTF-8">
	<title></title>
	<style>
		div.input{
			display:block;
			padding:5px;
			top: 10%;
			left:5%;
			width: 40%;
			height:80%;
			position:fixed;
			border-style: solid;
			background: white;
			z-index: 0;
			overflow-y: scroll;
			position:fixed;
			border-style: solid;
		}
		div.result{
			display:block;
			padding:5px;
			top: 10%;
			right:5%;
			width: 40%;
			height:80%;
			position:fixed;
			border-style: solid;
			background: white;
			z-index: 0;
			overflow-y: scroll;
			position:fixed;
			border-style: solid;
		}
		tr,th,td{
			border-style: solid;margin:2px;padding:2px
		}
		textarea{
			width: 80%;
			}
		button{
			width: 12em;
			height: 2em;
			font-size: 24px;
			}
		</style>
</head>
<body>
  <script src="lemmatizer/js/jquery.min.js"></script>
  <script src="lemmatizer/js/boyodict.js"></script>
  <script src="lemmatizer/js/dict_advanced.js"></script>
  <script src="lemmatizer/js/lemma.js"></script>
  <script src="lemmatizer/js/rare_lemmas.js"></script>
  <script type="text/javascript">

	function remove(array, element) {
		const index = array.indexOf(element);
		if(index!=-1){array.splice(index, 1);}
	};

    function escapeHTML(val) {
      return $('<div />').text(val).html();
    };
	lemma = lemma.concat(rare_lemmas);
	function lookupWord(sentence,prohibit){
		//抓出單字陣列
        var tmp_words = sentence.toLowerCase().replace(/[\'\’]/g," ").replace(/[\n\d+]/g," ").replace(/[“’—”‘\".,\/#!$\?%\^&\*;:{}=\-_`~()]/g," ").split(" ").sort().filter(function(elem, index, self) {
			return index == self.indexOf(elem) && elem.length > 2;
		});
		var words = [];
		
		tmp_words.forEach(function(word){
			var this_lemma = lemma.find(function(e){ return e.stem === word | e.extra.indexOf(word) != -1});
			if(this_lemma){word = this_lemma.stem;}
			words.push(word);
		});
		
		words=words.sort().filter(function(elem, index, self) {
			return index == self.indexOf(elem);
		});

		var newstring = "";
		if (prohibit < 45){
			
			newstring = "博幼國小400單字第" + prohibit + "課";
		}
		else if (prohibit == 45){
			newstring = "博幼國小400單字全";
		}
		else if (45 < prohibit && prohibit  < 85){
			newstring = "博幼國中800單字第" + (prohibit-45) + "課";
		}
		else if (prohibit == 85){
			newstring = "博幼國小800單字全";
		}
		else if(prohibit == 86){
			newstring = "國中2000單字";
		}
		
		var excep_words = [];
		
		
		for(var i = 1; i <= prohibit; i++){
			var level_index = i;
			var dict_head_string = "";
			var dict_string = "";
			
			if (level_index < 46) {
				dict_head_string = "boyo400_L";
			}
			else if (45 < level_index && level_index  < 86){
				dict_head_string = "boyo800_L";
				level_index = level_index - 45;
			}
			else if (level_index == 86){
				dict_head_string = "boyo2000";
			}
			dict_string = dict_head_string;
			if(level_index<10){ dict_string = dict_string + "0";}
			if(i != 86) {dict_string = dict_string + level_index;}
			words.forEach(function(e){
				if(boyodict[dict_string].indexOf(e)!=-1){
					excep_words.push(e);
				}
			});
		}
		excep_words.forEach(function(e){remove(words,e);});
		
		var html_word = '<div style="border-style: solid;margin:2px;padding:2px">\n';
		html_word  = html_word + "超出<b>"+newstring+"</b>範圍的單字，共"+words.length+"個<br/>\n";
		
		html_word  = html_word + "<table>\n";
		html_word  = html_word + "<tr>\n";
		for(var j = 0; j < 4; j++){
			html_word = html_word + "<th>\n";
			html_word += (j % 2) ? "解釋":"單字" ;
			html_word = html_word + "</th>\n";
		}html_word  = html_word + "</tr>\n";
		var w_index = 0;
		while(w_index != words.length){
			html_word = html_word + "<tr>\n";
			for(var j = 0; j < 2; j++){
				html_word += "<td";
				html_word += " style=\"color:red;\">\n";
				html_word += words[w_index];
				html_word += "</td>\n";
				
				html_word += "<td>\n";
				var w_dict = dictionary.find(function(e){return e.word === words[w_index]});
				if(w_dict){
					html_word += w_dict.translation.replace(/\n/,"<br/>");
				}else{html_word += "<a target=\"_blank\" href=\"https://www.collinsdictionary.com/dictionary/english-chinese/" + words[w_index] +  "\"> 查詢網路字典</a>" ;}
				html_word += "</td>\n";
					
				w_index++;
				if(w_index == words.length) {
					break;
				}
			}
			html_word = html_word + "</tr>\n";
		}html_word  = html_word + "</table></div>\n";
		return html_word;
	};
	
	$(document).ready( function() {
	  $("#divide-article").click( function(){
		var tmp_article = $("#article").val().replace(/\n/g," ").replace(/\b(\w{1,}\.\w{1,})\./g,"$1&period;").replace(/(Dr|Esq|Hon|Jr|Mr|Mrs|Ms|Messrs|Mmes|Msgr|Prof|Rev|Rt|Sr|St)\./g,"$1&period;").replace(/\b(\w?)\.(\w)\b/g,"$1&period;$2").match(/(.*?)([\.\?\!])/g);
		
		var level = $("#level").val();
		
		//words_html = lookupWord($("#article").val(),level);
		
		var work_result = "";
		var counter = 1;
		var space = "&nbsp;";
		tmp_article.forEach(function(e) {
			work_result = work_result + "<h3>第"+counter+"句:</h3><p>" + e + "</p>\n";
			work_result += "<p>答：<u>　　　　　　　　　　　　　　　　　　　　　</u></p>\n";
			words_html = lookupWord(e,level,lemma);
			work_result = work_result + words_html;
			counter ++;
		});
		$("#sentence-result").html(work_result);
      });
	  
	  $("#divide-article2").click( function(){
		var tmp_article = $("#article").val().replace(/\n/g," ").replace(/\b(\w{1,}\.\w{1,})\./g,"$1&period;").replace(/(Dr|Esq|Hon|Jr|Mr|Mrs|Ms|Messrs|Mmes|Msgr|Prof|Rev|Rt|Sr|St)\./g,"$1&period;").replace(/\b(\w?)\.(\w)\b/g,"$1&period;$2").match(/(.*?)([\.\?\!])/g);
		

		
		var level = $("#level").val();
		
		//words_html = lookupWord($("#article").val(),level);
		
		var work_result = "";
		var words_html = "";
		var counter = 1;
		work_result += "<h2>本文開始</h2>\n";
		work_result += "<p>\n";
		tmp_article.forEach(function(e) {
			var sentence_number = counter > 20 ? (12880 + counter - 20) : (9311 + counter);
			work_result += e + String.fromCharCode(sentence_number);
			words_html += "<h3>第" + counter + "句作答區:</h3>\n";
			words_html += "<p>___________________________________________________________________</p>\n";
			words_html += "<p>單字表:</p>\n";
			words_html += lookupWord(e,level,lemma);
			counter++;
		});
		work_result += "</p>\n";
		work_result = work_result + words_html;
		$("#sentence-result").html(work_result);
      });
	  
	  $("#level").change( function(){
		var prohibit = $("#level").val();
		
		
		var newstring = "";
		if (prohibit < 45){
			newstring = "博幼國小400單字第" + prohibit + "課";
		}
		else if (prohibit == 45){
			newstring = "博幼國小400單字全";
		}
		else if (45 < prohibit && prohibit  < 85){
			newstring = "博幼國中800單字第" + (prohibit-45) + "課";
		}
		else if (prohibit == 85){
			newstring = "博幼國小800單字全";
		}
		else if(prohibit == 86){
			newstring = "國中2000單字";
		}
		$("#slevel1").text(newstring);
		$("#slevel2").text(newstring);
	  });
    });
  </script>
  <div class="result">
	<div id="word-result"></div>
	<h1>處理結果：</h1>
	<div id="sentence-result"></div>
  </div>
  <div class="input">
  <button id="divide-article">處理文章 斷句形式</button>
  <button id="divide-article2">處理文章 標號形式</button>
	<form action="">
		<h2>要處理的文章:</h2>
		<h3 id="showlevel">單字程度：<span id="slevel2">博幼國小400單字全</span></h3>
		<p><input type="range" id="level" min="1" max="86"  value=45 style="width:25em"></p>
		<input id="result_words" type="hidden" />
		<textarea id='article' rows="20"></textarea>
	</form>
  </div>
</body>
</html>